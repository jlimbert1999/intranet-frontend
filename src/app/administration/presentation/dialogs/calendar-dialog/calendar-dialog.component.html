<form [formGroup]="eventForm" (ngSubmit)="save()">
 <div class="grid p-fluid gap-4">
  <div class="field">
   <label for="title" class="font-semibold">Título del Evento (*)</label>
   <input
    pInputText
    type="text"
    id="title"
    placeholder="Ej: Reunión de Gabinete"
    formControlName="title"
    autofocus
    [ngClass]="{'ng-invalid ng-dirty': eventForm.get('title')?.invalid && eventForm.get('title')?.touched}"
   />
   <small *ngIf="eventForm.get('title')?.touched && eventForm.get('title')?.hasError('required')" class="text-red-500">
    El título es obligatorio.
   </small>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
   <div class="field">
    <label for="start" class="font-semibold">Fecha de Inicio (*)</label>
    <p-datePicker
     formControlName="start"
     [minDate]="minDate"
     [showTime]="!eventForm.get('allDay')?.value"
     [hourFormat]="'24'"
     dateFormat="dd/mm/yy"
     [readonlyInput]="false"
     placeholder="Selecciona la fecha y hora"
     appendTo="body"
    ></p-datePicker>
    <small *ngIf="eventForm.errors?.['startRequired'] && eventForm.get('start')?.touched" class="text-red-500">
     La fecha de inicio es obligatoria a menos que el evento sea anual.
    </small>
   </div>

   <div class="field">
    <label for="end" class="font-semibold">Fecha de Finalización</label>
    <p-datepicker
     formControlName="end"
     [minDate]="minDate"
     [showTime]="!eventForm.get('allDay')?.value"
     [hourFormat]="'24'"
     dateFormat="dd/mm/yy"
     [readonlyInput]="false"
     placeholder="Fecha y hora de fin (opcional)"
     appendTo="body"
     [disabled]="eventForm.get('end')?.disabled ?? false"      [ngClass]="{'bg-gray-100': eventForm.get('end')?.disabled}"
    ></p-datepicker>
    <small *ngIf="eventForm.errors?.['endBeforeStart'] && eventForm.get('end')?.touched" class="text-red-500">
     La fecha final debe ser mayor o igual a la inicial.
    </small>
    <small *ngIf="eventForm.get('end')?.hasError('datePast') && eventForm.get('end')?.touched" class="text-red-500">
     La fecha/hora de fin no puede ser pasada.
    </small>
    <small *ngIf="eventForm.errors?.['endNotSameDay'] && (eventForm.get('end')?.touched || eventForm.get('start')?.touched)" class="text-red-500">
     Si no es un evento "todo el día", la fecha de fin debe estar en el mismo día que la fecha de inicio.
    </small>
   </div>
  </div>

  <div class="field-checkbox">
   <p-checkbox formControlName="allDay" binary="true" label="Evento de todo el día (Oculta la hora)" inputId="allDay"></p-checkbox>
   <div class="text-sm mt-2 ml-2 text-gray-600">
    <small>Si marcas "Evento de todo el día", el evento se guardará sin hora.</small>
   </div>
  </div>
 </div>

 <p-fieldset legend="Configuración de Recurrencia (Opcional)" [toggleable]="true" [collapsed]="true" class="mt-6">
  <div formGroupName="recurrence" class="grid gap-4 p-fluid">
   <div class="field">
    <label class="font-semibold">Frecuencia de Repetición</label>
    <p-select
     formControlName="freq"
     [options]="freqOptions"
     placeholder="Seleccionar Frecuencia"
     optionLabel="label"
     optionValue="value"
     appendTo="body"
    ></p-select>
   </div>

   <div class="field" *ngIf="showInterval()">
    <label class="font-semibold">Repetir cada (Intervalo)</label>
    <p-inputNumber formControlName="interval" [showButtons]="true" mode="decimal" [min]="1"></p-inputNumber>
   </div>

   <div class="field" *ngIf="eventForm.get('recurrence.freq')?.value === 'WEEKLY'">
    <label class="font-semibold">Días de la Semana</label>
    <p-multiSelect formControlName="byDay" [options]="weekdays" optionLabel="label" optionValue="value" placeholder="Días de la semana" appendTo="body"></p-multiSelect>
   </div>

   <ng-container *ngIf="eventForm.get('recurrence.freq')?.value === 'YEARLY'">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
     <div class="field">
      <label class="font-semibold">Mes</label>
      <p-select formControlName="byMonth" [options]="months" optionLabel="label" optionValue="value" placeholder="Selecciona un mes" appendTo="body"></p-select>
     </div>

     <div class="field">
      <label class="font-semibold">Día del Mes</label>
      <p-inputNumber formControlName="byMonthDay" [showButtons]="true" mode="decimal" [min]="1" [max]="31" placeholder="Día"></p-inputNumber>
      <small *ngIf="eventForm.get('recurrence.byMonthDay')?.value && eventForm.get('recurrence.byMonth')?.value && eventForm.get('recurrence.byMonthDay')?.value > daysInMonth(eventForm.get('recurrence.byMonth')?.value)" class="text-red-500">
       Día inválido para el mes seleccionado.
      </small>
     </div>
    </div>
   </ng-container>

   <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="field" *ngIf="eventForm.get('recurrence.freq')?.value !== 'YEARLY'">
     <label class="font-semibold">Repetir hasta (Fecha)</label>
     <p-datePicker 
                formControlName="until" 
                dateFormat="dd/mm/yy" 
                [readonlyInput]="false" 
                placeholder="Fecha límite" 
                appendTo="body"
            ></p-datePicker>
    </div>

    <div class="field" *ngIf="showCount()">
     <label class="font-semibold">Cantidad de repeticiones</label>
     <p-inputNumber formControlName="count" placeholder="Nº de repeticiones" [showButtons]="true" mode="decimal" [min]="1"></p-inputNumber>
    </div>
   </div>
  </div>
 </p-fieldset>
 
  <div class="p-dialog-footer mt-6 flex justify-end gap-2">
  <p-button label="Cancelar" severity="secondary" (onClick)="close()"></p-button>
  <p-button type="submit" label="Guardar Evento" icon="pi pi-check" [disabled]="eventForm.invalid"></p-button>
  <p-button *ngIf="isEditMode" label="Eliminar" severity="danger" icon="pi pi-trash" (onClick)="delete()"></p-button>
 </div>
</form>